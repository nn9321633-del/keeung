<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>keeung news</title>

  <style>
    /* ---------- Base ---------- */
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background: #000;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 414px; /* iPhone 기준 */
      aspect-ratio: 9 / 16;
      background: #f2f3f5;
      overflow-y: auto;
      position: relative;
    }

    /* ---------- Header ---------- */
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #E38Cb2;
      color: #fff;
      text-align: center;
      font-size: 18px;
      font-weight: 700;
      padding: 12px 0;
      border-radius: 0 0 16px 16px;
    }

    /* ---------- Article ---------- */
    .article-detail {
      background: #fff;
      padding: 16px; /* 8px grid x2 */
    }

    .category-badge {
      position: sticky;
      top: 48px; /* header 아래 */
      display: inline-block;
      margin-bottom: 8px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 600;
      color: #E38Cb2;
      background: rgba(227, 140, 178, 0.12);
      border-radius: 999px;
      transition: transform 0.25s ease, opacity 0.25s ease;
      transform-origin: left center;
      z-index: 1;
    }

    .category-badge.shrink {
      transform: scale(0.85);
      opacity: 0.9;
    }

    .title {
      font-size: 20px;
      font-weight: 700;
      line-height: 1.4;
      margin: 8px 0 6px;
    }

    .article-meta {
      font-size: 12px;
      color: #777;
      margin-bottom: 12px;
    }

    .article-meta span + span::before {
      content: "·";
      margin: 0 6px;
    }

    .article-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .article-actions button {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
    }

    /* ---------- ELLE Image ---------- */
    .article-figure {
      margin: -16px -16px 16px;
    }

    .article-figure img {
      width: 100%;
      max-height: 520px; /* 얼굴이 더 잘 보이도록 세로를 더 길게 */
      object-fit: cover;
      object-position: 50% 20%; /* 윗부분(얼얼굴) 쪽을 더 보여주기 */
      display: block;
      border-radius: 8px;
    }

    .article-figure figcaption {
      padding: 8px 16px;
      font-size: 12px;
      color: #999;
    }

    .article-content p {
      font-size: 14px;
      line-height: 1.6;
      color: #333;
      margin-bottom: 16px;
    }

    .article-content p:first-of-type {
      font-weight: 600;
    }

    /* ---------- Bottom Nav ---------- */
    nav {
      position: sticky;
      bottom: 0;
      background: #fff;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      font-size: 12px;
      z-index: 5;
    }

    nav div {
      color: #666;
    }

    /* ---------- Dim Overlay ---------- */
    .dim {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 15;
    }

    .dim.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* ---------- Comment Sheet ---------- */
    .comment-sheet {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: -100%;
      width: 100%;
      max-width: 480px; /* 댓글 UI 가로 폭 확대 */
      height: 70%;
      background: #fff;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 10px rgba(0,0,0,0.2);
      transition: bottom 0.3s ease;
      z-index: 20;
      display: flex;
      flex-direction: column;
      will-change: transform;
    }

    .comment-sheet.open { bottom: 0; }

    .comment-header {
      padding: 12px;
      font-weight: 700;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .comment-header .left {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .comment-header select {
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
    }

    .comment-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      font-size: 14px;
    }

    .comment {
      padding: 10px 0;
      border-bottom: 1px solid #f1f1f1;
    }

    .comment-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }

    .comment-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .comment-meta strong {
      display: inline-block;
      font-size: 13px;
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .comment-time {
      font-size: 12px;
      color: #999;
      white-space: nowrap;
    }

    .comment-text {
      font-size: 14px;
      color: #333;
      line-height: 1.4;
      word-break: break-word;
    }

    .comment-actions {
      display: flex;
      gap: 6px;
      flex: 0 0 auto;
    }

    .comment-actions button {
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #e6e6e6;
      background: #fff;
      cursor: pointer;
    }

    .comment-input {
      display: flex;
      gap: 6px;
      padding: 10px;
      border-top: 1px solid #eee;
      flex-wrap: wrap;
    }

    .comment-input input {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    #nicknameInput {
      width: 92px;
      flex: 0 0 auto;
    }

    #commentInput {
      flex: 1 1 180px;
      min-width: 160px;
    }

    .comment-input button {
      background: #E38Cb2;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    .hint {
      margin: 10px 12px 0;
      padding: 10px 12px;
      font-size: 12px;
      color: #7a2a4d;
      background: rgba(227, 140, 178, 0.12);
      border: 1px solid rgba(227, 140, 178, 0.25);
      border-radius: 12px;
      display: none;
    }
  </style>

  <!-- ✅ Firebase (compat: 정적 HTML에서 제일 쉬움) -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
</head>
<body>

  <div class="container" id="container">
    <header>keeung news</header>

    <article class="article-detail">
      <div class="category-badge" id="badge">연예</div>

      <h1 class="title">윤기호와 최지웅, 아이돌 그룹 내 연인으로.. 열애 인정</h1>

      <div class="article-meta">
        <span class="press">이내뉴스</span>
        <span class="date">2026.09.27 10:07</span>
      </div>

      <div class="article-actions">
        <button type="button" onclick="openComments()">댓글</button>
      </div>

      <div class="article-content">
        <figure class="article-figure">
          <img src="./news-photo.jpg" alt="P1Harmony 멤버 화보 이미지" />
          <figcaption>ⓒ ELLE</figcaption>
        </figure>

        <p>최근 아이돌 팬들에게 큰 소식을 전해준 두 남자 아이돌(P1Harmony) 윤기호와 최지웅이 같은 그룹 내에서 연인으로 발전한 사실을 공식적으로 인정했다. 그들의 사랑 이야기는 많은 팬들을 설레게 하며 뜨거운 관심을 모으고 있다.</p>
        <p>이번 열애 인정은 소속사(FNC)에서 공식 보도자료를 통해 발표되었으며, "기호와 지웅은 서로에 대한 깊은 신뢰와 애정을 바탕으로 연인 관계로 발전하게 되었다"는 내용이 포함되어 있었다. 이들은 같은 아이돌 그룹에 속해 있는 만큼, 팬들과의 소통과 활동에도 변별력을 줄 것으로 기대된다.</p>
        <p>윤기호는 그룹의 메인 보컬로, 특유의 감성적인 목소리로 팬들의 사랑을 받아왔다. 최지웅은 댄스와 퍼포먼스에 뛰어난 실력을 보이며 그룹의 매력을 한층 끌어올리는 역할을 하고 있다. 두 사람은 그룹 활동에 있어서도 서로를 응원하며 친구 같은 관계에서 연인으로 발전하게 된 것으로 알려졌다.</p>
        <p>P1Harmony 열렬한 팬인 김정배씨는 "처음 두 사람의 관계를 알게 되었을 때 매우 기뻤다. 두 사람 모두 너무 잘 어울린다"며, 이들의 사랑을 응원했다. 반면, 일부 팬들은 "연애 소식이 듣고 싶지 않았다"며 아쉬운 마음을 드러내기도 했다. 팬들의 반응이 상반되면서, 이들의 연애가 팬덤 내에서 새로운 화제를 불러일으키고 있다.</p>
        <p>소속사 측은 "팬들의 이해와 응원을 부탁드린다"며, 앞으로의 활동에 대한 기대감을 드러냈다. 이들은 현재 앨범 준비와 함께 다양한 콘텐츠를 통해 팬들과 소통할 계획이다. 또한, 연애 사실이 공개된 이후에도 그룹의 활동에 지장이 없도록 최선을 다할 것이라고 밝혔다.</p>
        <p>P1Harmony의 기호와 지웅의 연애는 단순한 개인적인 관계를 넘어, 국내 처음으로 아이돌 그룹 내에서의 사랑의 시작으로 많은 이들에게 영감을 주고 있다. 그들의 사랑은 팬들에게도 애정 어린 응원과 지지를 받을 수 있는 특별한 이야기가 될 것이며 앞으로의 컴백이 더욱 기대되는 이유가 된다.</p>
        <p>아이돌 그룹 내에서의 연애는 늘 팬들에게 다양한 반응을 불러일으키는 주제이다. 기호와 지웅의 사랑 이야기는 그들의 음악과 매력을 더욱 빛나게 할 것으로 예상된다. 팬들은 이들의 연애를 통해 새로운 시너지를 기대하며 더욱 뜨거운 응원을 보내고 있다. 앞으로 이들의 행보가 어떻게 펼쳐질지 많은 이들이 저마다의 마음으로 지켜보게 될 것이다.</p>
      </div>
    </article>

    <div class="dim" id="dim" onclick="closeComments()"></div>

    <div class="comment-sheet" id="commentSheet"
         ontouchstart="startDrag(event)" ontouchmove="onDrag(event)" ontouchend="endDrag()">
      <div class="comment-header">
        <div class="left">댓글 <span id="commentCount">0</span></div>
        <select id="sortOrder" aria-label="정렬">
          <option value="latest" selected>최신순</option>
          <option value="oldest">오래된순</option>
        </select>
      </div>

      <div class="comment-list" id="commentList"></div>

      <div class="comment-input">
        <input id="nicknameInput" type="text" placeholder="닉네임" maxlength="12" />
        <input id="commentInput" type="text" placeholder="댓글을 입력하세요" />
        <button id="commentSubmit" type="button">등록</button>
      </div>

      <div class="hint" id="hintBox">Firebase/Firestore 연결에 문제가 있어요. (Firestore 규칙/프로젝트 설정 확인)</div>
    </div>

    <nav>
      <div>홈</div>
      <div>뉴스</div>
      <div>마이</div>
    </nav>
  </div>

  <script>
    (function () {
      const container = document.getElementById('container');
      const badge = document.getElementById('badge');
      const sheet = document.getElementById('commentSheet');
      const dim = document.getElementById('dim');

      // ====== Bottom Sheet Open/Close (global) ======
      window.openComments = function openComments() {
        sheet.classList.add('open');
        dim.classList.add('show');
      };

      window.closeComments = function closeComments() {
        sheet.classList.remove('open');
        dim.classList.remove('show');
        sheet.style.transform = 'translateX(-50%)';
      };

      // ====== Swipe Down to Close (global) ======
      let startY = 0;
      let currentY = 0;

      window.startDrag = function startDrag(e) {
        startY = e.touches[0].clientY;
        currentY = startY;
      };

      window.onDrag = function onDrag(e) {
        currentY = e.touches[0].clientY;
        const diff = currentY - startY;
        if (diff > 0) sheet.style.transform = `translate(-50%, ${diff}px)`;
      };

      window.endDrag = function endDrag() {
        const diff = currentY - startY;
        if (diff > 120) window.closeComments();
        else sheet.style.transform = 'translateX(-50%)';
        startY = 0;
        currentY = 0;
      };

      // ====== Category badge shrink on scroll ======
      container.addEventListener('scroll', () => {
        if (container.scrollTop > 40) badge.classList.add('shrink');
        else badge.classList.remove('shrink');
      });

      // ====== Comment System (Firestore: everyone sees same comments) ======
      const commentList = document.getElementById('commentList');
      const commentCountEl = document.getElementById('commentCount');
      const nicknameInput = document.getElementById('nicknameInput');
      const commentInput = document.getElementById('commentInput');
      const commentSubmit = document.getElementById('commentSubmit');
      const sortOrder = document.getElementById('sortOrder');
      const hintBox = document.getElementById('hintBox');

      // ✅ 특정 닉네임 댓글 숨김(전체 사용자에게 동일 적용)
      const BLOCKED_NAMES = new Set(['ㅇㅅㅇㄹ', 'ㅍ']);

      const firebaseConfig = {
        apiKey: "AIzaSyAlm149mupSM70C0gxLOsR9mmwJR9hFaFY",
        authDomain: "keeping-e4061.firebaseapp.com",
        projectId: "keeping-e4061",
        storageBucket: "keeping-e4061.firebasestorage.app",
        messagingSenderId: "813363352404",
        appId: "1:813363352404:web:19b0c94d6db781a1fe6ec1"
      };

      // 내 기기 토큰: 내 댓글만 수정/삭제 버튼 보여주기
      const AUTHOR_KEY = 'keeung_author_token_v1';
      const authorToken = (function () {
        try {
          const exist = localStorage.getItem(AUTHOR_KEY);
          if (exist) return exist;
          const t = `t_${Date.now()}_${Math.random().toString(16).slice(2)}`;
          localStorage.setItem(AUTHOR_KEY, t);
          return t;
        } catch (_) {
          // (드물게) 프라이빗 모드에서 localStorage가 막힐 때 대비
          return `t_${Date.now()}_${Math.random().toString(16).slice(2)}`;
        }
      })();

      // ✅ Firestore에 authorToken이 저장되지 않았어도(규칙/이전데이터 등)
      //    내가 작성한 댓글 id를 로컬에 기록해두고 "내 댓글"로 인식하게 하는 안전장치
      const MY_IDS_KEY = 'keeung_my_comment_ids_v1';
      const myCommentIds = (function () {
        try {
          const raw = localStorage.getItem(MY_IDS_KEY);
          const arr = raw ? JSON.parse(raw) : [];
          return new Set(Array.isArray(arr) ? arr : []);
        } catch (_) {
          return new Set();
        }
      })();

      function persistMyIds() {
        try {
          localStorage.setItem(MY_IDS_KEY, JSON.stringify(Array.from(myCommentIds)));
        } catch (_) {}
      }

      let db = null;
      let unsubscribe = null;

      function showHint(show) {
        hintBox.style.display = show ? 'block' : 'none';
      }

      function formatRelativeTime(tsMs) {
        const diff = Date.now() - tsMs;
        const sec = Math.floor(diff / 1000);
        if (sec < 30) return '방금 전';
        if (sec < 60) return '1분 전';
        const min = Math.floor(sec / 60);
        if (min < 60) return `${min}분 전`;
        const hr = Math.floor(min / 60);
        if (hr < 24) return `${hr}시간 전`;
        const day = Math.floor(hr / 24);
        return `${day}일 전`;
      }

      function safeTimestampToMs(ts) {
        if (!ts) return Date.now();
        try {
          if (typeof ts.toDate === 'function') return ts.toDate().getTime();
        } catch (_) {}
        return Date.now();
      }

      function setCount(n) {
        commentCountEl.textContent = String(n);
      }

      function renderDocs(docs) {
        commentList.innerHTML = '';

        docs.forEach((doc) => {
          const data = doc.data();
          // ✅ 차단 닉네임 댓글은 목록에서 숨김
          if (data && typeof data.name === 'string' && BLOCKED_NAMES.has(data.name.trim())) return;
          const item = document.createElement('div');
          item.className = 'comment';
          item.dataset.id = doc.id;

          const top = document.createElement('div');
          top.className = 'comment-top';

          const meta = document.createElement('div');
          meta.className = 'comment-meta';

          const name = document.createElement('strong');
          name.textContent = data.name || '익명';

          const time = document.createElement('span');
          time.className = 'comment-time';

          const tsMs = safeTimestampToMs(data.ts);
          time.textContent = formatRelativeTime(tsMs);
          item.dataset.tsms = String(tsMs);

          meta.appendChild(name);
          meta.appendChild(time);

          const actions = document.createElement('div');
          actions.className = 'comment-actions';

          const isMine = (data.authorToken && data.authorToken === authorToken) || myCommentIds.has(doc.id);

          if (isMine) {
            const delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.dataset.action = 'delete';
            delBtn.textContent = '삭제';

            actions.appendChild(delBtn);
          }

          top.appendChild(meta);
          top.appendChild(actions);

          const text = document.createElement('div');
          text.className = 'comment-text';
          text.textContent = data.text || '';

          item.appendChild(top);
          item.appendChild(text);
          commentList.appendChild(item);
        });

        setCount(docs.length);
        commentList.scrollTop = (sortOrder.value === 'latest') ? 0 : commentList.scrollHeight;
      }

      function attachListener() {
        if (!db) return;
        if (unsubscribe) unsubscribe();

        const dir = (sortOrder.value === 'latest') ? 'desc' : 'asc';

        // ✅ 기본: ts 기준 정렬 (권장)
        // ⚠️ 기존 데이터 중 ts 필드가 없는 문서가 있으면 orderBy에서 에러가 날 수 있어서,
        // 에러가 나면 정렬 없이 받아온 뒤(안전) 클라이언트에서 정렬한다.
        try {
          unsubscribe = db.collection('comments')
            .orderBy('ts', dir)
            .onSnapshot((snap) => {
              showHint(false);
              renderDocs(snap.docs);
            }, (err) => {
              console.error(err);
              // orderBy 실패 시(예: ts 없는 문서) fallback
              if (unsubscribe) { try { unsubscribe(); } catch (_) {} }
              unsubscribe = db.collection('comments')
                .onSnapshot((snap2) => {
                  showHint(false);
                  const docs = snap2.docs.slice().sort((a, b) => {
                    const at = safeTimestampToMs(a.data().ts);
                    const bt = safeTimestampToMs(b.data().ts);
                    return (sortOrder.value === 'latest') ? (bt - at) : (at - bt);
                  });
                  renderDocs(docs);
                }, (err2) => {
                  console.error(err2);
                  showHint(true);
                });
            });
        } catch (e) {
          console.error(e);
          showHint(true);
        }
      }

      function initFirebase() {
        try {
          if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
          db = firebase.firestore();
          attachListener();
          showHint(false);
        } catch (e) {
          console.error(e);
          showHint(true);
        }
      }

      async function addComment() {
        const name = (nicknameInput.value || '').trim() || '익명';
        const text = (commentInput.value || '').trim();
        if (!text) return;
        if (!db) { showHint(true); return; }

        try {
          const docRef = await db.collection('comments').add({
            name,
            text,
            authorToken,
            ts: firebase.firestore.FieldValue.serverTimestamp(),
          });
          // ✅ 방금 내가 쓴 댓글은 id로도 기억(버튼이 '아예 안 보이는' 문제 방지)
          if (docRef && docRef.id) {
            myCommentIds.add(docRef.id);
            persistMyIds();
          }
          commentInput.value = '';
        } catch (e) {
          console.error(e);
          showHint(true);
        }
      }

      // 등록
      commentSubmit.addEventListener('click', addComment);
      commentInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') addComment();
      });

      // 수정/삭제 (내 댓글만 버튼 노출)
      commentList.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;

        const item = btn.closest('.comment');
        if (!item) return;

        const id = item.dataset.id;
        if (!id || !db) return;

        const action = btn.dataset.action;
        try {
          if (action === 'delete') {
            await db.collection('comments').doc(id).delete();
            return;
          }
        } catch (e2) {
          console.error(e2);
          showHint(true);
        }
      });

      // 정렬 변경
      sortOrder.addEventListener('change', attachListener);

      // 키보드 올라올 때
      commentInput.addEventListener('focus', () => { sheet.style.height = '85%'; });
      commentInput.addEventListener('blur', () => { sheet.style.height = '70%'; });

      // 시간 표시 업데이트 (30초마다)
      setInterval(() => {
        document.querySelectorAll('.comment').forEach(el => {
          const tsMs = Number(el.dataset.tsms || 0);
          const timeEl = el.querySelector('.comment-time');
          if (timeEl && tsMs) timeEl.textContent = formatRelativeTime(tsMs);
        });
      }, 30000);

      initFirebase();
    })();
  </script>
</body>
</html>
